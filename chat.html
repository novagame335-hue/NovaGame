let isAdmin = false;
let currentChatUid = null; // UID пользователя, чей чат сейчас открыт у админа

auth.onAuthStateChanged((user) => {
    if (user) {
        db.ref('users/' + user.uid).once('value').then((snapshot) => {
            const userData = snapshot.val();
            isAdmin = (userData && userData.role === 'admin');
            
            if (isAdmin) {
                setupAdminUI();
            } else {
                // Для юзера "целевой чат" — это его собственный UID
                currentChatUid = user.uid;
                setupUserUI();
                loadMessages(currentChatUid);
            }
        });
    } else {
        window.location.href = "login.html";
    }
});

// --- ЛОГИКА ДЛЯ АДМИНА ---
function setupAdminUI() {
    document.querySelector('.side-header').innerText = "Все тикеты";
    const listArea = document.getElementById('chat-list');
    listArea.innerHTML = ""; // Очистка списка

    // Слушаем список всех, кто написал в поддержку
    db.ref('support_tickets').on('value', (snapshot) => {
        listArea.innerHTML = "";
        snapshot.forEach((child) => {
            const userUid = child.key;
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.innerHTML = `
                <div class="chat-info">
                    <h4>ID: ${userUid.substring(0, 8)}</h4>
                    <p>Нажмите, чтобы ответить</p>
                </div>
            `;
            chatItem.onclick = () => {
                currentChatUid = userUid;
                loadMessages(userUid);
                // Подсвечиваем активный чат
                document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
                chatItem.classList.add('active');
            };
            listArea.appendChild(chatItem);
        });
    });
}

// --- ЛОГИКА ОТПРАВКИ ---
function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text || !currentChatUid) return;

    const sender = auth.currentUser;
    db.ref(`support_tickets/${currentChatUid}/messages`).push({
        senderUid: sender.uid,
        name: isAdmin ? "Nova Game (Support)" : (sender.displayName || "User"),
        text: text,
        timestamp: Date.now(),
        role: isAdmin ? "admin" : "user"
    });
    input.value = "";
}

// --- ЗАГРУЗКА СООБЩЕНИЙ ---
function loadMessages(ticketId) {
    const msgArea = document.getElementById('msg-area');
    msgArea.innerHTML = ""; // Очищаем окно при смене чата

    // Отписываемся от старых чатов и подписываемся на новый
    db.ref(`support_tickets/${ticketId}/messages`).off();
    db.ref(`support_tickets/${ticketId}/messages`).on('child_added', (snapshot) => {
        const data = snapshot.val();
        const isMy = data.senderUid === auth.currentUser.uid;

        const msgDiv = document.createElement('div');
        msgDiv.className = isMy ? 'msg sent' : 'msg received';
        
        // Красим сообщения админов
        if (data.role === "admin") {
            msgDiv.style.background = isMy ? "var(--neon-red)" : "#440000";
            msgDiv.innerHTML = `<small style="display:block; font-size:9px; opacity:0.7;">SUPPORT</small>${data.text}`;
        } else {
            msgDiv.innerText = data.text;
        }

        msgArea.appendChild(msgDiv);
        msgArea.scrollTop = msgArea.scrollHeight;
    });
}
