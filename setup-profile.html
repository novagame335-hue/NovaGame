<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка профиля — NovaGame</title>
    
    <link rel="icon" type="image/png" href="Logo780.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body {
            margin: 0;
            background: radial-gradient(circle at center, #350101, #000000, #220101, #000000);
            background-size: 300% 300%;
            animation: smoothBG 20s ease-in-out infinite;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        @keyframes smoothBG {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        .setup-card {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #ff0000;
            text-align: center;
            width: 380px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
        }

        /* Контейнер для аватарки с возможностью клика */
        .avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            cursor: pointer;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ff0000;
            object-fit: cover;
            background: #222;
            transition: 0.3s;
        }

        .avatar-container:hover .avatar-preview {
            opacity: 0.7;
        }

        /* Скрытая надпись "Загрузить" при наведении */
        .avatar-container::after {
            content: "ЗАГРУЗИТЬ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
        }

        .avatar-container:hover::after {
            opacity: 1;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            box-sizing: border-box;
            outline: none;
            text-align: center;
        }

        input[type="text"]:focus { border-color: #ff0000; }

        .btn-save {
            width: 100%;
            padding: 14px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-save:hover { background: #cc0000; }
        
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="setup-card">
    <div class="avatar-container" onclick="document.getElementById('file-input').click()">
        <img id="pre-pic" src="default-avatar.png" class="avatar-preview">
    </div>
    <input type="file" id="file-input" accept="image/*" onchange="previewImage(this)">

    <h2>Придумайте никнейм</h2>
    <p style="font-size: 14px; color: #888;">Этот ник будут видеть другие пользователи</p>
    
    <input type="text" id="username-input" placeholder="Ваш ник..." maxlength="15">
    
    <button class="btn-save" onclick="saveProfile()">СОХРАНИТЬ И ВОЙТИ</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmVusnUmwqWTMRSUeL4uTF_yrXQvZA0eQ",
        authDomain: "novagame-b15b6.firebaseapp.com",
        databaseURL: "https://novagame-b15b6-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "novagame-b15b6",
        storageBucket: "novagame-b15b6.firebasestorage.app",
        messagingSenderId: "7572791951",
        appId: "1:7572791951:web:7c207e63da98fd9c28c6fa"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let base64Image = "default-avatar.png"; // По умолчанию

    // Проверка авторизации
    auth.onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });

    // Функция предпросмотра картинки при выборе файла
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('pre-pic').src = e.target.result;
                base64Image = e.target.result; // Сохраняем строку картинки
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveProfile() {
        const user = auth.currentUser;
        const name = document.getElementById('username-input').value.trim();

        if (name.length < 3) {
            alert("Никнейм слишком короткий (минимум 3 символа)!");
            return;
        }

        if (user) {
            db.ref('users/' + user.uid).set({
                username: name,
                profilePic: base64Image, // Сохраняем загруженную картинку
                balance: 0,
                email: user.email,
                uid: user.uid
            }).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                alert("Ошибка: " + error.message);
            });
        }
    }
</script>

</body>
</html>
